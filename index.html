<script>
    let currentSource = 'sirin';
    let data = { sirin: [], nabulsi: [], shahin: [] };

    // تحميل البيانات مع معالجة الأخطاء لضمان استمرارية الموقع
    async function loadData() {
        try {
            const [s, n, h] = await Promise.all([
                fetch('data_sirin.json').then(r => r.ok ? r.json() : []),
                fetch('data_nabulsi.json').then(r => r.ok ? r.json() : []),
                fetch('data_shahin.json').then(r => r.ok ? r.json() : [])
            ]);
            data.sirin = s;
            data.nabulsi = n;
            data.shahin = h;
            console.log("تم تحميل كافة المجلدات بنجاح");
        } catch (e) { 
            console.error("حدث خطأ في جلب ملفات البيانات، تأكد من وجود الملفات في GitHub"); 
        }
    }

    function changeSource(src) {
        currentSource = src;
        // تحديث شكل الأزرار
        document.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active'));
        if(event) event.target.classList.add('active');
        
        const names = { 
            sirin: 'تفسير الإمام ابن سيرين', 
            nabulsi: 'تفسير الشيخ النابلسي', 
            shahin: 'تفسير العالم ابن شاهين' 
        };
        document.getElementById('mufasirTitle').innerText = names[src];
        search(); // إعادة البحث فوراً عند تغيير المفسر
    }

    // وظيفة التنظيف لجعل البحث ذكياً (إزالة الـ التعريف والهمزات)
    function cleanWord(word) {
        if (!word) return "";
        return word.replace(/^(ال)/, "")
                   .replace(/[أإآا]/g, "ا")
                   .replace(/ة/g, "ه")
                   .trim();
    }

    function search() {
        const query = document.getElementById('searchInput').value.trim();
        const resDiv = document.getElementById('resultText');
        
        if (!query) {
            resDiv.innerHTML = `<p class="text-center text-muted fs-5" style="font-family:'Tajawal'">اكتب الكلمة الأساسية للرؤيا لبدء البحث..</p>`;
            resDiv.classList.add('text-center');
            return;
        }

        const cleanQuery = cleanWord(query);
        
        // البحث في المجلد المختار حالياً
        const found = data[currentSource].find(item => {
            const cleanEntry = cleanWord(item.word);
            return cleanEntry === cleanQuery || item.word.includes(query) || query.includes(item.word);
        });
        
        if (found) {
            resDiv.classList.remove('text-center');
            resDiv.innerHTML = `<strong style="color:var(--royal-blue)">تفسير رمز (${query}) عند ${document.getElementById('mufasirTitle').innerText}:</strong><br>${found.interpretation}`;
        } else {
            resDiv.classList.add('text-center');
            resDiv.innerHTML = `
                <p class="text-danger py-4" style="font-family:'Tajawal'">
                    عذراً، رمز "<strong>${query}</strong>" غير متوفر في هذا المجلد.<br>
                    <small class="text-muted">نصيحة: جرب الضغط على مفسر آخر في الأعلى أو كتابة الكلمة بدون "الـ".</small>
                </p>`;
        }
    }

    document.getElementById('searchInput').addEventListener('input', search);
    window.onload = loadData; // تحميل البيانات بمجرد فتح الصفحة
</script>



